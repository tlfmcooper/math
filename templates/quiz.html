<!DOCTYPE html>
<html lang="{{ g.locale }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>{{ _('Quiz Time!') }}</title>
    <!-- Preconnect for faster font loading -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <!-- Non-blocking font load -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap"></noscript>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <!-- PWA -->
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='icons/icon-192.svg') }}">
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='icons/favicon.svg') }}">
    <!-- Load confetti async -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js" async></script>
    <style>
        /* Internal styles for the overlay logic */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #f0f8ff 0%, #e8f4fc 100%);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 100;
            padding: 20px;
        }
        .overlay h2 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: #333;
        }
        .mood-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
            max-width: 350px;
        }
        @media (min-width: 480px) {
            .mood-grid {
                grid-template-columns: repeat(4, 1fr);
                max-width: 600px;
            }
        }
        .mood-grid button {
            font-size: 1.3rem;
            padding: 20px 15px;
            border: 3px solid #e0e0e0;
            border-radius: 15px;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 80px;
            font-family: inherit;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .mood-grid button:hover {
            transform: translateY(-3px);
            border-color: #3498db;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }
        .mood-grid button:focus {
            outline: 3px solid #3498db;
            outline-offset: 2px;
        }
    </style>
</head>
<body>
    <div class="container-card">

        <!-- Mood Check-in Overlay -->
        <div id="mood-overlay" class="overlay" role="dialog" aria-labelledby="mood-title">
            <h2 id="mood-title">{{ _('How are you feeling today?') }}</h2>
            <p style="color:#666;margin-bottom:10px;">{{ _('This helps us understand how you are doing!') }}</p>
            <div class="mood-grid" role="group" aria-label="{{ _('Mood selection') }}">
                <button onclick="startGame('ü§© {{ _('Excited') }}')" aria-label="{{ _('I am feeling excited') }}">ü§©<br>{{ _('Excited') }}</button>
                <button onclick="startGame('üôÇ {{ _('Calm') }}')" aria-label="{{ _('I am feeling calm') }}">üôÇ<br>{{ _('Calm') }}</button>
                <button onclick="startGame('ü•± {{ _('Tired') }}')" aria-label="{{ _('I am feeling tired') }}">ü•±<br>{{ _('Tired') }}</button>
                <button onclick="startGame('üò§ {{ _('Frustrated') }}')" aria-label="{{ _('I am feeling frustrated') }}">üò§<br>{{ _('Frustrated') }}</button>
            </div>
        </div>

        <!-- Main Game UI -->
        <div id="game-ui" class="hidden">
            <div class="header">
                <span id="strand-badge">{{ strand|title }}</span>
                <span id="streak-display" class="hidden"></span>
                <span id="score-board">‚≠ê 0</span>
            </div>

            <!-- Progress Bar -->
            <div class="progress-container">
                <div class="progress-text" id="progress-text">{{ _('Question') }} 1</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
            </div>

            <div id="game-area">
                <h2 id="question-text" aria-live="polite">{{ _('Loading...') }}</h2>
                <div id="options-container" role="group" aria-label="{{ _('Answer options') }}"></div>
                <p id="feedback" aria-live="assertive"></p>
            </div>

            <div style="margin-top: 20px;">
                <button id="next-btn" class="hidden" onclick="loadQuestion()" aria-label="{{ _('Next question') }}">{{ _('Next') }} ‚û°Ô∏è</button>
                <button id="finish-btn" class="hidden" onclick="finishSession()" aria-label="{{ _('Finish and save your progress') }}">{{ _('Finish & Save') }} üíæ</button>
            </div>
        </div>
    </div>

    <!-- Mascot -->
    <div id="mascot" class="mascot hidden">
        <div class="mascot-bubble" id="mascot-text">{{ _('You have got this!') }}</div>
        <div class="mascot-emoji" aria-hidden="true">ü¶ä</div>
    </div>

<script>
    // Translations for JavaScript
    const i18n = {
        question: "{{ _('Question') }}",
        correct: "{{ _('Correct!') }}",
        loading: "{{ _('Loading...') }}",
        couldNotLoad: "{{ _('Oops! Could not load question. Please try again.') }}",
        saving: "{{ _('Saving...') }}",
        couldNotSave: "{{ _('Could not save. Please try again.') }}",
        theAnswerWas: "{{ _('The answer was') }}",
        // Mascot messages
        start: ["{{ _('You have got this!') }}", "{{ _('Let us learn together!') }}", "{{ _('Math is fun!') }}", "{{ _('Ready to explore?') }}"],
        correctMsg: ["{{ _('Amazing!') }}", "{{ _('You are so smart!') }}", "{{ _('Keep going!') }}", "{{ _('Fantastic!') }}", "{{ _('Wonderful!') }}", "{{ _('Great job!') }}"],
        wrongMsg: ["{{ _('It is okay!') }}", "{{ _('You are learning!') }}", "{{ _('Try the next one!') }}", "{{ _('Keep trying!') }}", "{{ _('Almost there!') }}"],
        streak3: ["{{ _('Wow! 3 in a row!') }}", "{{ _('You are on fire!') }} üî•"],
        streak5: ["{{ _('5 in a row! Super Star!') }}", "{{ _('Incredible!') }}"],
        finish: ["{{ _('Great job today!') }}", "{{ _('You did awesome!') }}", "{{ _('See you next time!') }}"],
        // Growth mindset feedback
        growthMindset: [
            "{{ _('Not quite yet! Mistakes help your brain grow.') }} üß†",
            "{{ _('Close! Take a deep breath and try the next one.') }}",
            "{{ _('That was tricky! You are still learning.') }}",
            "{{ _('Keep going! Every mistake teaches you something new.') }}"
        ],
        // Achievements
        onFire: "{{ _('On Fire!') }} üî•",
        threeInRow: "{{ _('3 in a row!') }}",
        superStar: "{{ _('Super Star!') }} ‚≠ê",
        fiveInRow: "{{ _('5 in a row!') }}",
        mathWizard: "{{ _('Math Wizard!') }} üßô",
        tenInRow: "{{ _('10 in a row!') }}"
    };

    // Game state
    let currentScore = 0;
    let totalQuestions = 0;
    let currentStreak = 0;
    let maxStreak = 0;
    const strand = "{{ strand }}";
    let sessionLog = [];
    let startMood = "";

    function updateMascot(state) {
        let messages;
        if (state === 'start') messages = i18n.start;
        else if (state === 'correct') messages = i18n.correctMsg;
        else if (state === 'wrong') messages = i18n.wrongMsg;
        else if (state === 'streak3') messages = i18n.streak3;
        else if (state === 'streak5') messages = i18n.streak5;
        else if (state === 'finish') messages = i18n.finish;
        else messages = i18n.start;

        const msg = messages[Math.floor(Math.random() * messages.length)];
        document.getElementById('mascot-text').innerText = msg;
    }

    function showAchievementBadge(title, subtitle) {
        const badge = document.createElement('div');
        badge.className = 'achievement-badge';
        badge.innerHTML = `<h3>${title}</h3><p>${subtitle}</p>`;
        badge.setAttribute('role', 'alert');
        document.body.appendChild(badge);
        setTimeout(() => badge.remove(), 3000);
    }

    function updateStreak(isCorrect) {
        const streakDisplay = document.getElementById('streak-display');

        if (isCorrect) {
            currentStreak++;
            maxStreak = Math.max(currentStreak, maxStreak);

            if (currentStreak >= 3) {
                streakDisplay.className = 'streak-counter';
                streakDisplay.innerHTML = `üî• ${currentStreak}`;
            }

            // Achievement badges at milestones
            if (currentStreak === 3) {
                showAchievementBadge(i18n.onFire, i18n.threeInRow);
                updateMascot('streak3');
            } else if (currentStreak === 5) {
                showAchievementBadge(i18n.superStar, i18n.fiveInRow);
                updateMascot('streak5');
            } else if (currentStreak === 10) {
                showAchievementBadge(i18n.mathWizard, i18n.tenInRow);
            }
        } else {
            currentStreak = 0;
            streakDisplay.className = 'streak-counter hidden';
        }
    }

    function updateProgress() {
        document.getElementById('progress-text').innerText = `${i18n.question} ${totalQuestions + 1}`;
        // Progress bar fills based on questions answered (assuming ~10 questions per session)
        const progress = Math.min((totalQuestions / 10) * 100, 100);
        document.getElementById('progress-fill').style.width = `${progress}%`;
    }

    function startGame(mood) {
        startMood = mood;
        document.getElementById('mood-overlay').classList.add('hidden');
        document.getElementById('game-ui').classList.remove('hidden');
        document.getElementById('mascot').classList.remove('hidden');
        updateMascot('start');
        loadQuestion();
    }

    function loadQuestion() {
        document.getElementById('feedback').innerHTML = "";
        document.getElementById('next-btn').classList.add('hidden');
        updateProgress();

        fetch(`/api/get_question/${strand}`)
            .then(r => r.json())
            .then(data => {
                window.currentQ = data;
                document.getElementById('question-text').innerHTML = data.q;
                const container = document.getElementById('options-container');
                container.innerHTML = '';

                data.options.forEach((opt, index) => {
                    let btn = document.createElement('button');
                    btn.className = 'option-btn';
                    btn.innerHTML = opt;
                    btn.setAttribute('aria-label', `Option ${index + 1}: ${opt}`);
                    btn.onclick = () => checkAnswer(opt, data.a);
                    container.appendChild(btn);
                });
            })
            .catch(err => {
                console.error('Error loading question:', err);
                document.getElementById('question-text').innerHTML = i18n.couldNotLoad;
            });
    }

    function checkAnswer(selected, correct) {
        const feedback = document.getElementById('feedback');
        totalQuestions++;
        const isCorrect = String(selected) === String(correct);

        sessionLog.push({
            q_html: window.currentQ.q,
            user_ans: selected,
            correct_ans: correct,
            is_correct: isCorrect
        });

        updateStreak(isCorrect);

        if (isCorrect) {
            currentScore++;
            document.getElementById('score-board').innerText = `‚≠ê ${currentScore}`;
            feedback.innerHTML = `<h2 style='color:#2ecc71'>üéâ ${i18n.correct}</h2>`;
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
            if (currentStreak < 3) updateMascot('correct');
        } else {
            // Growth mindset feedback
            const msg = i18n.growthMindset[Math.floor(Math.random() * i18n.growthMindset.length)];
            feedback.innerHTML = `<h2 style='color:#e67e22'>${msg}</h2><p>${i18n.theAnswerWas} <strong>${correct}</strong></p>`;
            updateMascot('wrong');
        }

        document.querySelectorAll('.option-btn').forEach(b => b.disabled = true);
        document.getElementById('next-btn').classList.remove('hidden');
        document.getElementById('finish-btn').classList.remove('hidden');

        // Update progress bar
        const progress = Math.min((totalQuestions / 10) * 100, 100);
        document.getElementById('progress-fill').style.width = `${progress}%`;
    }

    async function finishSession() {
        const btn = document.getElementById('finish-btn');
        btn.disabled = true;
        btn.innerHTML = `${i18n.saving} <span class="spinner"></span>`;

        updateMascot('finish');
        const today = new Date().toLocaleString();
        const sessionData = {
            date: today,
            strand: strand,
            mood: startMood,
            score_str: `${currentScore}/${totalQuestions}`,
            percent: Math.round((currentScore / totalQuestions) * 100),
            details: sessionLog,
            max_streak: maxStreak
        };

        // Check if user is logged in (passed from template)
        const isGuest = {{ 'false' if user.is_authenticated else 'true' }};

        if (isGuest) {
            // Save to localStorage for guests
            const localHistory = JSON.parse(localStorage.getItem('mathHistory') || '[]');
            sessionData.id = 'local-' + Date.now();
            sessionData.isLocal = true;
            localHistory.unshift(sessionData);
            localStorage.setItem('mathHistory', JSON.stringify(localHistory.slice(0, 50)));
            window.location.href = '/history';
        } else {
            // Save to server for logged-in users
            try {
                await fetch('/api/save_session', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(sessionData)
                });
                window.location.href = '/history';
            } catch (err) {
                btn.disabled = false;
                btn.innerHTML = '{{ _("Finish & Save") }} üíæ';
                alert(i18n.couldNotSave);
            }
        }
    }

    // Keyboard navigation for answer options (1-4 keys)
    document.addEventListener('keydown', (e) => {
        const options = document.querySelectorAll('.option-btn:not([disabled])');
        if (e.key >= '1' && e.key <= '4') {
            const index = parseInt(e.key) - 1;
            if (options[index]) {
                options[index].click();
            }
        }
        // Enter or Space to go to next question
        if (e.key === 'Enter' || e.key === ' ') {
            const nextBtn = document.getElementById('next-btn');
            if (!nextBtn.classList.contains('hidden')) {
                e.preventDefault();
                nextBtn.click();
            }
        }
    });
</script>
</body>
</html>
